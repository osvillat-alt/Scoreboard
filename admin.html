<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scoreboard - En Vivo (OVT)</title>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
  <script src="firebase.js"></script>

  <style>
    :root{
      --bg:#0b0b0b;
      --card:#141414;
      --line:#2a2a2a;
      --accent:#f6c000;
      --text:#f5f5f5;
      --muted:#bdbdbd;
    }
    body{ margin:0; font-family:Arial,Helvetica,sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:980px; margin:0 auto; padding:18px; }
    .topline{ text-align:center; color:var(--muted); margin-bottom:10px; }
    .card{
      background:linear-gradient(180deg,#141414,#101010);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 14px 50px rgba(0,0,0,.35);
    }
    .scoreRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      border-top:3px solid var(--accent);
      padding-top:12px;
    }
    .teamBox{
      flex:1 1 280px;
      border-radius:14px;
      padding:14px;
      text-align:center;
      font-weight:800;
      font-size:22px;
      color:#fff;
      position:relative;
    }
    .pos{ font-size:14px; opacity:.95; margin-top:8px; font-weight:700; }
    .centerScore{
      flex:0 0 160px;
      text-align:center;
      font-size:44px;
      font-weight:900;
      letter-spacing:1px;
    }
    .status{
      text-align:center;
      margin:14px 0 8px;
      font-size:22px;
      font-weight:800;
    }
    .tabs{ display:flex; gap:10px; justify-content:center; margin:16px 0 10px; }
    .tabBtn{
      background:#121212;
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      min-width:140px;
    }
    .tabBtn.active{ border-color:var(--accent); }
    .panel{ display:none; }
    .panel.active{ display:block; }

    .timeline{
      margin-top:12px;
      background:#121212;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .tlItem{
      padding:10px 6px;
      border-bottom:1px solid #222;
      font-size:16px;
    }
    .tlItem:last-child{ border-bottom:none; }

    /* Poll bar */
    .pollCard{
      margin-top:12px;
      background:#121212;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .bar{
      display:flex;
      width:100%;
      height:18px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid #2a2a2a;
      background:#0e0e0e;
      margin-top:10px;
    }
    .seg{ height:100%; }
    .pollRow{
      display:flex;
      justify-content:space-between;
      margin-top:8px;
      font-size:13px;
      color:var(--muted);
    }

    .qbCard{
      margin-top:12px;
      background:#121212;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .qbTitle{ font-size:18px; font-weight:900; margin-bottom:8px; }
    .qbLine{ font-size:15px; margin:4px 0; }

    .watermark{
      position: fixed;
      right: 14px;
      bottom: 10px;
      width: 110px;
      opacity: 0.12;
      pointer-events:none;
      filter: drop-shadow(0 4px 12px rgba(0,0,0,.5));
    }
  </style>
</head>

<body>
  <img class="watermark" src="bb6b5054-8bfb-4159-b6c0-b19a23ba52b3.png" alt="OVT" />

  <div class="wrap">
    <div class="topline" id="meta">—</div>

    <div class="card">
      <div class="scoreRow">
        <div class="teamBox" id="homeBox">
          <div id="homeName">Local</div>
          <div class="pos" id="homePos"></div>
        </div>

        <div class="centerScore">
          <span id="homeScore">0</span> - <span id="awayScore">0</span>
        </div>

        <div class="teamBox" id="awayBox">
          <div id="awayName">Visitante</div>
          <div class="pos" id="awayPos"></div>
        </div>
      </div>

      <div class="status" id="status">Cuarto: 1Q</div>

      <div class="tabs">
        <button class="tabBtn active" onclick="showTab('tab_score')">Marcador</button>
        <button class="tabBtn" onclick="showTab('tab_stats')">Estadísticas</button>
      </div>

      <div class="panel active" id="tab_score">
        <div class="pollCard" id="pollCard" style="display:none;">
          <div style="font-weight:900;">¿Quién ganará?</div>
          <div class="bar">
            <div class="seg" id="segHome" style="width:50%;"></div>
            <div class="seg" id="segAway" style="width:50%;"></div>
          </div>
          <div class="pollRow">
            <div><span id="pollHomePct">50%</span> <span id="pollHomeName">Local</span></div>
            <div><span id="pollAwayName">Visitante</span> <span id="pollAwayPct">50%</span></div>
          </div>
        </div>

        <div class="timeline" id="timeline"></div>
      </div>

      <div class="panel" id="tab_stats">
        <div class="qbCard" id="qbCard">
          <div class="qbTitle" id="qbTitle">Estadísticas del QB</div>
          <div class="qbLine" id="qbNameLine">Nombre: —</div>
          <div class="qbLine" id="qbPassYds">Yds pase: 0</div>
          <div class="qbLine" id="qbPassTd">TD pase: 0</div>
          <div class="qbLine" id="qbInts">Intercepciones: 0</div>
          <div class="qbLine" id="qbRushYds">Yds tierra: 0</div>
          <div class="qbLine" id="qbRushTd">TD tierra: 0</div>
        </div>
      </div>

    </div>
  </div>

<script>
  function showTab(id){
    document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
    document.querySelectorAll(".tabBtn").forEach(b=>b.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    const btn = Array.from(document.querySelectorAll(".tabBtn")).find(x => (id==="tab_score" ? x.textContent.includes("Marcador") : x.textContent.includes("Estadísticas")));
    if(btn) btn.classList.add("active");
  }

  const refTeams = db.ref("teams");
  const refGame  = db.ref("game");

  let TEAMS = {};

  refTeams.on("value", snap => {
    TEAMS = snap.val() || {};
  });

  function setTeamBox(boxId, nameElId, posElId, teamName, possession, side){
    const box = document.getElementById(boxId);
    const nameEl = document.getElementById(nameElId);
    const posEl = document.getElementById(posElId);

    nameEl.textContent = teamName || (side==="home" ? "Local" : "Visitante");

    const color = TEAMS?.[teamName]?.color || (side==="home" ? "#2b6cb0" : "#0b2a7a");
    box.style.background = color;

    if(possession === side){
      posEl.textContent = (side==="home" ? "← Posesión" : "Posesión →");
    }else{
      posEl.textContent = "";
    }
  }

  function renderTimeline(tl){
    const wrap = document.getElementById("timeline");
    wrap.innerHTML = "";
    const arr = Array.isArray(tl) ? tl : [];
    if(arr.length===0){
      wrap.innerHTML = `<div class="tlItem" style="opacity:.8;">Sin jugadas registradas todavía.</div>`;
      return;
    }
    arr.slice().reverse().forEach(item=>{
      const div = document.createElement("div");
      div.className = "tlItem";
      div.textContent = item;
      wrap.appendChild(div);
    });
  }

  function renderQB(qb){
    const title = document.getElementById("qbTitle");
    const nameLine = document.getElementById("qbNameLine");

    if(!qb){
      title.textContent = "Estadísticas del QB";
      nameLine.textContent = "Nombre: —";
      document.getElementById("qbPassYds").textContent = "Yds pase: 0";
      document.getElementById("qbPassTd").textContent = "TD pase: 0";
      document.getElementById("qbInts").textContent = "Intercepciones: 0";
      document.getElementById("qbRushYds").textContent = "Yds tierra: 0";
      document.getElementById("qbRushTd").textContent = "TD tierra: 0";
      return;
    }

    const team = qb.team || "—";
    const name = qb.name || "—";
    const st = qb.stats || {};

    title.textContent = `Estadísticas del QB de ${team}`;
    nameLine.textContent = `Nombre: ${name}`;
    document.getElementById("qbPassYds").textContent = `Yds pase: ${st.pass_yds || 0}`;
    document.getElementById("qbPassTd").textContent = `TD pase: ${st.pass_td || 0}`;
    document.getElementById("qbInts").textContent = `Intercepciones: ${st.ints || 0}`;
    document.getElementById("qbRushYds").textContent = `Yds tierra: ${st.rush_yds || 0}`;
    document.getElementById("qbRushTd").textContent = `TD tierra: ${st.rush_td || 0}`;
  }

  function renderPoll(data){
    const enabled = !!data.pollEnabled;
    const card = document.getElementById("pollCard");
    if(!enabled){
      card.style.display = "none";
      return;
    }

    const home = data.team_home || "Local";
    const away = data.team_away || "Visitante";

    const votes = data.pollVotes || {};
    const homeVotes = Object.values(votes).filter(v => v === "home").length;
    const awayVotes = Object.values(votes).filter(v => v === "away").length;
    const total = homeVotes + awayVotes;

    // Si no hay votos, 50/50 visual
    let homePct = total ? Math.round((homeVotes/total)*100) : 50;
    let awayPct = total ? 100 - homePct : 50;

    // sin empate: si por rounding quedan iguales con total>0, empuja 1% al que va arriba
    if(total && homePct === awayPct){
      if(homeVotes > awayVotes){ homePct = 51; awayPct = 49; }
      else if(awayVotes > homeVotes){ homePct = 49; awayPct = 51; }
    }

    document.getElementById("pollHomeName").textContent = home;
    document.getElementById("pollAwayName").textContent = away;
    document.getElementById("pollHomePct").textContent = `${homePct}%`;
    document.getElementById("pollAwayPct").textContent = `${awayPct}%`;

    const segH = document.getElementById("segHome");
    const segA = document.getElementById("segAway");

    segH.style.width = `${homePct}%`;
    segA.style.width = `${awayPct}%`;

    // Colores según equipo
    const cH = TEAMS?.[home]?.color || "#2b6cb0";
    const cA = TEAMS?.[away]?.color || "#0b2a7a";
    segH.style.background = cH;
    segA.style.background = cA;

    card.style.display = "block";
  }

  refGame.on("value", snap=>{
    const data = snap.val() || {};

    const home = data.team_home || "Local";
    const away = data.team_away || "Visitante";

    document.getElementById("meta").textContent =
      `${data.location || "—"} • ${data.date || "—"}`;

    document.getElementById("homeScore").textContent = data.score_home ?? 0;
    document.getElementById("awayScore").textContent = data.score_away ?? 0;

    setTeamBox("homeBox","homeName","homePos", home, data.possession, "home");
    setTeamBox("awayBox","awayName","awayPos", away, data.possession, "away");

    // Status: cuarto o final
    if(data.finished){
      document.getElementById("status").textContent = "Partido finalizado";
    }else{
      document.getElementById("status").textContent = `Cuarto: ${data.quarter || "1Q"}`;
    }

    renderTimeline(data.timeline || []);
    renderPoll(data);

    // QB
    const qb = data.players?.qb || null;
    renderQB(qb);
  });
</script>
</body>
</html>

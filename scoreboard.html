<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Marcador en Vivo</title>

  <!-- Firebase compat (igual que admin) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
  <script src="firebase.js"></script>

  <style>
    :root{
      --bg:#000;
      --panel:#111;
      --line:#2a2a2a;
      --txt:#fff;
      --muted:rgba(255,255,255,.75);
      --gold:#f1c40f;
    }

    body{
      margin:0;
      background:var(--bg);
      color:var(--txt);
      font-family: Arial, sans-serif;
      padding:16px;
    }

    .wrap{
      max-width:980px;
      margin:0 auto;
    }

    /* Tabs */
    .tabs{
      display:flex;
      gap:10px;
      border-bottom:2px solid var(--line);
      margin-bottom:14px;
    }
    .tab{
      background:transparent;
      color:var(--muted);
      border:0;
      font-size:16px;
      padding:10px 12px;
      cursor:pointer;
      border-bottom:3px solid transparent;
    }
    .tab.active{
      color:var(--txt);
      border-bottom:3px solid var(--gold);
    }

    /* Header (Lugar + Fecha) */
    .meta{
      text-align:center;
      color:var(--muted);
      margin:10px 0 8px;
      font-size:16px;
    }

    /* Scoreboard bar */
    .scorebar{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap:14px;
      align-items:center;
      box-shadow: 0 6px 25px rgba(0,0,0,.35);
    }

    .teamCard{
      border-radius:12px;
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      min-height:74px;
      position:relative;
      overflow:hidden;
    }

    .teamName{
      font-size:20px;
      font-weight:800;
      line-height:1.1;
      text-transform: none;
      max-width:70%;
      word-break: break-word;
    }

    .teamScore{
      font-size:32px;
      font-weight:900;
      min-width:54px;
      text-align:right;
    }

    .possessionBadge{
      position:absolute;
      bottom:8px;
      right:10px;
      font-size:13px;
      font-weight:700;
      opacity:.92;
      background:rgba(0,0,0,.35);
      padding:4px 8px;
      border-radius:999px;
      display:none;
    }
    .teamCard.possession .possessionBadge{ display:block; }

    /* Center block */
    .centerBlock{
      text-align:center;
      padding:8px 8px;
    }
    .centerBlock .dash{
      font-size:34px;
      font-weight:900;
      opacity:.95;
    }
    .centerBlock .q{
      margin-top:6px;
      font-size:16px;
      color:var(--muted);
      font-weight:700;
    }

    /* Timeline */
    .timelineBox{
      margin-top:16px;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
    }
    .timelineTitle{
      font-size:18px;
      font-weight:800;
      margin:0 0 10px;
    }
    .timeline{
      list-style:none;
      padding:0;
      margin:0;
    }
    .timeline li{
      padding:10px 8px;
      border-top:1px solid rgba(255,255,255,.08);
      font-size:15px;
      color:rgba(255,255,255,.92);
    }
    .timeline li:first-child{ border-top:0; }

    /* Stats */
    .statCard{
      margin-top:14px;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
    }
    .statCard h2{
      margin:0 0 8px;
      font-size:18px;
    }
    .statLine{ margin:6px 0; color:rgba(255,255,255,.92); }
    .muted{ color:var(--muted); }

    /* History */
    .historyRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }
    select, button{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#1a1a1a;
      color:var(--txt);
      font-size:15px;
    }
    button{ cursor:pointer; }
    button.primary{
      background: #222;
      border-color: rgba(241,196,15,.35);
    }

    /* Mobile */
    @media (max-width:720px){
      .scorebar{
        grid-template-columns: 1fr;
      }
      .centerBlock{
        order:2;
      }
      .teamCard.home{ order:1; }
      .teamCard.away{ order:3; }
      .teamName{ font-size:18px; }
      .teamScore{ font-size:30px; }
      .centerBlock .dash{ font-size:30px; }
    }
   
.watermark {
  position: fixed;
  bottom: 16px;
  right: 16px;
  width: 80px;              
  opacity: 0.20;            
  pointer-events: none;    
  z-index: 9999;
  filter: drop-shadow(0 0 6px rgba(0,0,0,0.6));
}

@media (max-width: 720px) {
  .watermark {
    width: 70px;
    opacity: 0.16;
  }
}

  </style>
</head>

<body>
  
<img
  src="bb6b5054-8bfb-4159-b6c0-b19a23ba52b3.png"
  alt="OVT"
  class="watermark"
/>

<div class="wrap">

  <!-- Tabs -->
  <div class="tabs">
    <button id="tabScore" class="tab active" onclick="showTab('score')">Marcador</button>
    <button id="tabStats" class="tab" onclick="showTab('stats')">Estadísticas</button>
    <button id="tabHistory" class="tab" onclick="showTab('history')">Historial</button>
  </div>

  <!-- VIEW: SCORE -->
  <div id="viewScore">
    <div class="meta" id="metaLine">—</div>

    <div class="scorebar">
      <div id="homeCard" class="teamCard home">
        <div class="teamName" id="homeName">Local</div>
        <div class="teamScore" id="homeScore">0</div>
        <div class="possessionBadge" id="homePoss">Posesión →</div>
      </div>

      <div class="centerBlock">
        <div class="dash">-</div>
        <div class="q" id="quarterLine">Cuarto: —</div>
      </div>

      <div id="awayCard" class="teamCard away">
        <div class="teamName" id="awayName">Visitante</div>
        <div class="teamScore" id="awayScore">0</div>
        <div class="possessionBadge" id="awayPoss">← Posesión</div>
      </div>
    </div>

    <div class="timelineBox">
      <div class="timelineTitle">Crónica</div>
      <ul class="timeline" id="timelineList"></ul>
    </div>
  </div>

  <!-- VIEW: STATS -->
  <div id="viewStats" style="display:none;">
    <div class="statCard">
      <h2 id="qbTitle">Estadísticas del QB</h2>
      <div class="statLine" id="qbNameLine">Nombre: —</div>
      <div class="statLine" id="qbCmpLine">CMP/ATT: 0/0 (0%)</div>

      <div class="statLine" id="qbPassYds">Yds pase: 0</div>
      <div class="statLine" id="qbPassTd">TD pase: 0</div>
      <div class="statLine" id="qbInts">Intercepciones: 0</div>
      <div class="statLine" id="qbRushYds">Yds tierra: 0</div>
      <div class="statLine" id="qbRushTd">TD tierra: 0</div>

      <div class="muted" style="margin-top:10px;font-size:13px;">
        Estas estadísticas se actualizan en vivo desde el panel administrador.
      </div>
    </div>
  </div>

  <!-- VIEW: HISTORY -->
  <div id="viewHistory" style="display:none;">
    <div class="statCard">
      <h2>Historial</h2>
      <div class="muted" style="font-size:13px;">
        Selecciona un partido guardado para verlo aquí (solo lectura). No afecta el partido en vivo.
      </div>

      <div class="historyRow">
        <select id="history_select" style="min-width:260px; max-width:520px;"></select>
        <button class="primary" onclick="loadHistoryToViewer()">Ver partido</button>
        <button onclick="backToLive()">Volver a en vivo</button>
      </div>

      <div id="history_hint" class="muted" style="margin-top:10px;font-size:13px;">
        —
      </div>
    </div>
  </div>

</div>

<script>
  // ===== Firebase refs =====
  const refGame = db.ref("game");
  const refTeams = db.ref("teams");
  const refHistory = db.ref("history");

  // Cache de colores por equipo
  const teamColors = {};

  refTeams.on("value", snap => {
    const teams = snap.val() || {};
    for (const name in teams){
      teamColors[name] = teams[name]?.color || "#444";
    }
  });

  // ===== Tabs =====
  function showTab(tab) {
    document.getElementById("viewScore").style.display = (tab === "score") ? "block" : "none";
    document.getElementById("viewStats").style.display = (tab === "stats") ? "block" : "none";
    document.getElementById("viewHistory").style.display = (tab === "history") ? "block" : "none";

    document.getElementById("tabScore").classList.toggle("active", tab === "score");
    document.getElementById("tabStats").classList.toggle("active", tab === "stats");
    document.getElementById("tabHistory").classList.toggle("active", tab === "history");
  }

  // ===== Helper =====
  function safeText(x){ return (x === null || x === undefined || x === "") ? "—" : String(x); }

  function paintTeamCard(side, teamName, score, possessionSide){
    const isHome = (side === "home");
    const card = document.getElementById(isHome ? "homeCard" : "awayCard");
    const nameEl = document.getElementById(isHome ? "homeName" : "awayName");
    const scoreEl = document.getElementById(isHome ? "homeScore" : "awayScore");

    nameEl.textContent = safeText(teamName === "—" ? (isHome ? "Local" : "Visitante") : teamName);
    scoreEl.textContent = (score ?? 0);

    const color = teamColors[teamName] || (isHome ? "#1b5" : "#15b") || "#444";
    card.style.background = color;

    // Posesión
    card.classList.toggle("possession", possessionSide === side);
  }

  function renderMeta(data){
    const loc = safeText(data.location);
    const date = safeText(data.date);
    const meta = (loc === "—" && date === "—") ? "—" : `${loc} • ${date}`;
    document.getElementById("metaLine").textContent = meta;
  }

  function renderQuarter(data){
    const finished = !!data.finished;
    if (finished){
      document.getElementById("quarterLine").textContent = "PARTIDO FINALIZADO";
    } else {
      document.getElementById("quarterLine").textContent = `Cuarto: ${safeText(data.quarter)}`;
    }
  }

  function renderTimeline(data){
    const list = document.getElementById("timelineList");
    list.innerHTML = "";
    const tl = data.timeline || [];
    if (!tl.length){
      list.innerHTML = `<li class="muted">Sin jugadas registradas todavía.</li>`;
      return;
    }
    // Mostrar en orden (como se fue agregando)
    tl.forEach(item => {
      const li = document.createElement("li");
      li.textContent = item;
      list.appendChild(li);
    });
    // Auto-scroll al final (última jugada visible)
    list.parentElement.scrollTop = list.parentElement.scrollHeight;
  }

  // ===== QB Stats =====
  function calcCmpPct(cmp, att){
    if(!att) return "0%";
    return ((cmp / att) * 100).toFixed(1) + "%";
  }

  function renderQB(qb){
    const title = document.getElementById("qbTitle");
    const nameLine = document.getElementById("qbNameLine");
    const cmpLine = document.getElementById("qbCmpLine");

    if(!qb){
      title.textContent = "Estadísticas del QB";
      nameLine.textContent = "Nombre: —";
      cmpLine.textContent = "CMP/ATT: 0/0 (0%)";
      document.getElementById("qbPassYds").textContent = "Yds pase: 0";
      document.getElementById("qbPassTd").textContent = "TD pase: 0";
      document.getElementById("qbInts").textContent = "Intercepciones: 0";
      document.getElementById("qbRushYds").textContent = "Yds tierra: 0";
      document.getElementById("qbRushTd").textContent = "TD tierra: 0";
      return;
    }

    const team = qb.team || "—";
    const name = qb.name || "—";
    const st = qb.stats || {};

    const cmp = st.pass_cmp || 0;
    const att = st.pass_att || 0;
    const pct = calcCmpPct(cmp, att);

    title.textContent = `Estadísticas del QB de ${team}`;
    nameLine.textContent = `Nombre: ${name}`;
    cmpLine.textContent = `CMP/ATT: ${cmp}/${att} (${pct})`;

    document.getElementById("qbPassYds").textContent = `Yds pase: ${st.pass_yds || 0}`;
    document.getElementById("qbPassTd").textContent = `TD pase: ${st.pass_td || 0}`;
    document.getElementById("qbInts").textContent = `Intercepciones: ${st.ints || 0}`;
    document.getElementById("qbRushYds").textContent = `Yds tierra: ${st.rush_yds || 0}`;
    document.getElementById("qbRushTd").textContent = `TD tierra: ${st.rush_td || 0}`;
  }

  // ===== Live / History switch =====
  let liveListenerOn = false;

  function startLive(){
    if (liveListenerOn) return;
    liveListenerOn = true;

    refGame.on("value", snap => {
      const data = snap.val() || {};

      renderMeta(data);

      const homeName = data.team_home || "Local";
      const awayName = data.team_away || "Visitante";
      paintTeamCard("home", homeName, data.score_home ?? 0, data.possession);
      paintTeamCard("away", awayName, data.score_away ?? 0, data.possession);

      renderQuarter(data);
      renderTimeline(data);

      const qb = (data.players && data.players.qb) ? data.players.qb : null;
      renderQB(qb);
    });
  }

  function stopLive(){
    if (!liveListenerOn) return;
    liveListenerOn = false;
    refGame.off();
  }

  function backToLive(){
    document.getElementById("history_hint").textContent = "Modo en vivo activo.";
    stopLive();
    startLive();
    showTab("score");
  }

  // ===== Historial list =====
  refHistory.on("value", snap => {
    const sel = document.getElementById("history_select");
    const hint = document.getElementById("history_hint");
    const data = snap.val() || {};
    const keys = Object.keys(data).sort((a,b)=>Number(b)-Number(a));

    sel.innerHTML = "";
    if (!keys.length){
      sel.innerHTML = `<option value="">(No hay juegos guardados)</option>`;
      hint.textContent = "No hay historial todavía.";
      return;
    }

    keys.forEach(k=>{
      const g = data[k] || {};
      const home = g.team_home || "Local";
      const away = g.team_away || "Visitante";
      const sh = (g.score_home ?? 0);
      const sa = (g.score_away ?? 0);
      const fecha = g.date ? ` • ${g.date}` : "";
      sel.innerHTML += `<option value="${k}">${home} ${sh} - ${sa} ${away}${fecha}</option>`;
    });

    hint.textContent = "Selecciona un juego y presiona “Ver partido”.";
  });

  function loadHistoryToViewer(){
    const key = document.getElementById("history_select").value;
    if (!key) return alert("No hay juego seleccionado.");

    // Detenemos live para que no pise la vista
    stopLive();

    refHistory.child(key).once("value").then(snap=>{
      const data = snap.val();
      if (!data) return alert("No se encontró ese juego.");

      renderMeta(data);

      const homeName = data.team_home || "Local";
      const awayName = data.team_away || "Visitante";
      paintTeamCard("home", homeName, data.score_home ?? 0, data.possession);
      paintTeamCard("away", awayName, data.score_away ?? 0, data.possession);

      // en historial normalmente está finished:true
      renderQuarter(data);
      renderTimeline(data);

      const qb = (data.players && data.players.qb) ? data.players.qb : null;
      renderQB(qb);

      document.getElementById("history_hint").textContent = "Viendo partido guardado (solo lectura).";
      showTab("score");
    }).catch(err=>{
      console.error(err);
      alert("Error al cargar historial.");
    });
  }

  // Arrancar
  startLive();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Marcador en Vivo</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
<script src="firebase.js"></script>

<style>
body{
margin:0;
background:#0b0c15;
color:white;
font-family:Orbitron;
padding:15px;
}

.wrap{max-width:1100px;margin:auto;}

.tabs{
display:flex;
justify-content:center;
margin-bottom:20px;
}

.tab{
background:#111;
border:1px solid #333;
color:#777;
padding:10px 25px;
cursor:pointer;
font-weight:bold;
margin:0 3px;
}

.tab.active{
color:#f39c12;
border-color:#f39c12;
}

.scoreboard{
background:#000;
border-radius:10px;
overflow:hidden;
box-shadow:0 0 25px black;
}

.scoreboard-inner{
display:grid;
grid-template-columns:1fr auto 1fr;
}

.team-panel{
display:flex;
align-items:center;
justify-content:space-between;
padding:20px;
position:relative;
}

.team-panel::before{
content:"";
position:absolute;
inset:0;
background:linear-gradient(90deg,var(--team-color,#222),transparent 80%);
opacity:.7;
}

.team-panel.away::before{
background:linear-gradient(-90deg,var(--team-color,#222),transparent 80%);
}

.team-logo{
width:80px;
height:80px;
border-radius:50%;
overflow:hidden;
z-index:2;
}

.team-logo img{width:100%;height:100%;object-fit:cover;}

.team-info{z-index:2}

.team-name{
font-family:Roboto;
font-size:20px;
font-weight:bold;
}

.team-score{
font-size:60px;
font-weight:900;
}

.center-block{
display:flex;
align-items:center;
justify-content:center;
width:70px;
background:#111;
font-weight:bold;
}

.bottom-bar{
display:flex;
justify-content:space-between;
padding:10px 20px;
background:#111;
}

.quarter-dot{
width:12px;
height:12px;
background:#222;
display:inline-block;
margin:2px;
}

.quarter-dot.active{
background:#f39c12;
box-shadow:0 0 6px #f39c12;
}

.quarter-dot.completed{
background:#555;
}

.timeline li{
border-left:3px solid #f39c12;
padding-left:10px;
margin:8px 0;
font-family:Roboto;
}

.content-box{
background:#111;
padding:15px;
margin-top:20px;
}

.watermark{
position:fixed;
bottom:15px;
right:15px;
width:60px;
opacity:.18;
pointer-events:none;
}

</style>
</head>

<body>

<img src="bb6b5054-8bfb-4159-b6c0-b19a23ba52b3.png" class="watermark"/>

<div class="wrap">

<div class="tabs">
<button id="tabScore" class="tab active" onclick="showTab('score')">Marcador</button>
<button id="tabStats" class="tab" onclick="showTab('stats')">EstadÃ­sticas</button>
<button id="tabHistory" class="tab" onclick="showTab('history')">Historial</button>
</div>

<!-- SCORE -->
<div id="viewScore">

<div id="metaLine" style="text-align:center;margin-bottom:15px;font-family:Roboto"></div>

<div class="scoreboard">
<div class="scoreboard-inner">

<div id="homePanel" class="team-panel home">
<div id="homeLogo" class="team-logo"></div>
<div class="team-info">
<div id="homeName" class="team-name">Local</div>
<div id="homeScore" class="team-score">0</div>
</div>
</div>

<div class="center-block">VS</div>

<div id="awayPanel" class="team-panel away">
<div id="awayLogo" class="team-logo"></div>
<div class="team-info">
<div id="awayName" class="team-name">Visitante</div>
<div id="awayScore" class="team-score">0</div>
</div>
</div>

</div>

<div class="bottom-bar">
<div>
CUARTO: <span id="quarterText">1Q</span>
<div id="quarterBadges">
<div class="quarter-dot"></div>
<div class="quarter-dot"></div>
<div class="quarter-dot"></div>
<div class="quarter-dot"></div>
</div>
</div>

<div id="statusBadge">EN VIVO</div>
</div>
</div>

<div class="content-box">
<h3>CrÃ³nica del partido</h3>
<ul id="timelineList"></ul>
</div>

</div>

<!-- STATS -->
<div id="viewStats" style="display:none">
<div id="stats_container" class="content-box">

<div id="qbTitle">EstadÃ­sticas QB</div>
<div id="qbName">Nombre: â€”</div>
<div id="qbPct">CMP/ATT: 0/0</div>

<div>Yds Pase: <span id="qbPassYds">0</span></div>
<div>TD Pase: <span id="qbPassTd">0</span></div>
<div>INTs: <span id="qbInts">0</span></div>
<div>Yds Tierra: <span id="qbRushYds">0</span></div>
<div>TD Tierra: <span id="qbRushTd">0</span></div>

</div>
</div>

<!-- HISTORY -->
<div id="viewHistory" style="display:none">
<div class="content-box">

<select id="history_select"></select>
<button onclick="loadHistoryToViewer()">Ver partido</button>
<button onclick="backToLive()">Volver en vivo</button>

<div id="history_hint"></div>

</div>
</div>

</div>

<script>
  // ===== Firebase refs =====
  const refGame = db.ref("game");
  const refTeams = db.ref("teams");
  const refHistory = db.ref("history");

  // Cache de datos de equipo
  const teamData = {};
  let logoManifest = {};

  // Load logo manifest
  fetch('logos/manifest.json')
    .then(res => res.json())
    .then(data => {
      (data.logos || []).forEach(l => {
        logoManifest[l.id] = l;
      });
    })
    .catch(() => console.warn('No se pudo cargar manifest de logos'));

  refTeams.on("value", snap => {
    const teams = snap.val() || {};
    for (const name in teams) {
      teamData[name] = {
        color: teams[name]?.color || "#444",
        logoId: teams[name]?.logoId || null
      };
    }
  });

  // ===== Tabs =====
  function showTab(tab) {
    document.getElementById("viewScore").style.display = (tab === "score") ? "block" : "none";
    document.getElementById("viewStats").style.display = (tab === "stats") ? "block" : "none";
    document.getElementById("viewHistory").style.display = (tab === "history") ? "block" : "none";

    document.getElementById("tabScore").classList.toggle("active", tab === "score");
    document.getElementById("tabStats").classList.toggle("active", tab === "stats");
    document.getElementById("tabHistory").classList.toggle("active", tab === "history");
  }

  function safeText(x) {
    return (x === null || x === undefined || x === "") ? "â€”" : String(x);
  }

  function getInitials(name) {
    if (!name) return "?";
    const words = name.trim().split(/\s+/);
    if (words.length === 1) return words[0].substring(0, 2).toUpperCase();
    return (words[0][0] + words[1][0]).toUpperCase();
  }

  function getLogoPath(logoId) {
    if (!logoId || !logoManifest[logoId]) return null;
    return 'logos/' + logoManifest[logoId].file;
  }

  function paintTeamPanel(side, teamName, score, possessionSide) {
    const isHome = (side === "home");
    const panel = document.getElementById(isHome ? "homePanel" : "awayPanel");
    const nameEl = document.getElementById(isHome ? "homeName" : "awayName");
    const scoreEl = document.getElementById(isHome ? "homeScore" : "awayScore");
    const logoEl = document.getElementById(isHome ? "homeLogo" : "awayLogo");

    const displayName = teamName || (isHome ? "Local" : "Visitante");
    nameEl.textContent = displayName;
    scoreEl.textContent = score ?? 0;

    const data = teamData[teamName] || {};
    const color = data.color || (isHome ? "#c0392b" : "#2980b9");
    panel.style.setProperty('--team-color', color);

    const logoPath = getLogoPath(data.logoId);
    const initials = getInitials(displayName);

    logoEl.innerHTML = logoPath
      ? `<img src="${logoPath}" alt="${displayName}" onerror="this.parentElement.innerHTML='<span class=\\'initials\\'>${initials}</span>'" />`
      : `<span class="initials">${initials}</span>`;

    panel.classList.toggle("possession", possessionSide === side);
  }

  function renderMeta(data) {
    document.getElementById("metaLocation").textContent = safeText(data.location);
    document.getElementById("metaDate").textContent = safeText(data.date);
  }

  function renderQuarter(data) {
    const finished = !!data.finished;
    const quarterText = document.getElementById("quarterText");
    const statusBadge = document.getElementById("statusBadge");

    if (finished) {
      quarterText.textContent = "FINAL";
      statusBadge.className = "status-badge final";
      statusBadge.innerHTML = "FINALIZADO";
    } else {
      quarterText.textContent = safeText(data.quarter || "1Q");
      statusBadge.className = "status-badge";
      statusBadge.innerHTML = "ðŸ”´ EN VIVO";
    }
  }

  function renderTimeline(data) {
    const list = document.getElementById("timelineList");
    list.innerHTML = "";

    const tl = data.timeline || [];
    if (!tl.length) {
      list.innerHTML = `<li class="muted">Sin jugadas registradas todavÃ­a.</li>`;
      return;
    }

    [...tl].reverse().forEach(item => {
      const li = document.createElement("li");
      li.textContent = item;
      list.appendChild(li);
    });
  }

  // ===== QB =====
  function calcCmpPct(cmp, att) {
    if (!att) return "0%";
    return ((cmp / att) * 100).toFixed(1) + "%";
  }

  function renderQB(qb) {
    const title = document.getElementById("qbTitle");
    const nameLine = document.getElementById("qbName");
    const cmpLine = document.getElementById("qbPct");

    if (!qb) {
      title.textContent = "EstadÃ­sticas del QB";
      nameLine.textContent = "Nombre: â€”";
      cmpLine.textContent = "CMP/ATT: 0/0 (0%)";
      document.getElementById("qbPassYds").textContent = 0;
      document.getElementById("qbPassTd").textContent = 0;
      document.getElementById("qbInts").textContent = 0;
      document.getElementById("qbRushYds").textContent = 0;
      document.getElementById("qbRushTd").textContent = 0;
      return;
    }

    const st = qb.stats || {};
    const cmp = st.pass_cmp || 0;
    const att = st.pass_att || 0;
    const pct = calcCmpPct(cmp, att);

    title.textContent = `EstadÃ­sticas del QB de ${qb.team || "â€”"}`;
    nameLine.textContent = `Nombre: ${qb.name || "â€”"}`;
    cmpLine.textContent = `CMP/ATT: ${cmp}/${att} (${pct})`;

    document.getElementById("qbPassYds").textContent = st.pass_yds || 0;
    document.getElementById("qbPassTd").textContent = st.pass_td || 0;
    document.getElementById("qbInts").textContent = st.ints || 0;
    document.getElementById("qbRushYds").textContent = st.rush_yds || 0;
    document.getElementById("qbRushTd").textContent = st.rush_td || 0;
  }

  // ===== LIVE =====
  let liveListenerOn = false;

  function startLive() {
    if (liveListenerOn) return;
    liveListenerOn = true;

    refGame.on("value", snap => {
      const data = snap.val() || {};

      renderMeta(data);

      paintTeamPanel("home", data.team_home, data.score_home, data.possession);
      paintTeamPanel("away", data.team_away, data.score_away, data.possession);

      renderQuarter(data);
      renderTimeline(data);

      const qb = data.players?.qb || null;
      renderQB(qb);
    });
  }

  function stopLive() {
    if (!liveListenerOn) return;
    liveListenerOn = false;
    refGame.off();
  }

  // ===== HISTORY =====
  refHistory.on("value", snap => {
    const sel = document.getElementById("history_select");
    const data = snap.val() || {};
    const keys = Object.keys(data).sort((a, b) => Number(b) - Number(a));

    sel.innerHTML = "";

    if (!keys.length) {
      sel.innerHTML = `<option value="">(No hay juegos guardados)</option>`;
      return;
    }

    keys.forEach(k => {
      const g = data[k];
      sel.innerHTML += `<option value="${k}">
        ${g.team_home} ${g.score_home} - ${g.score_away} ${g.team_away}
      </option>`;
    });
  });

  function loadHistoryToViewer() {
    const key = document.getElementById("history_select").value;
    if (!key) return;

    stopLive();

    refHistory.child(key).once("value").then(snap => {
      const data = snap.val();
      if (!data) return;

      renderMeta(data);
      paintTeamPanel("home", data.team_home, data.score_home, data.possession);
      paintTeamPanel("away", data.team_away, data.score_away, data.possession);
      renderQuarter(data);
      renderTimeline(data);
      renderQB(data.players?.qb || null);
    });
  }

  function backToLive() {
    stopLive();
    startLive();
    showTab("score");
  }

  // Start
  startLive();
</script>
/script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Marcador en Vivo</title>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
  <script src="firebase.js"></script>

  <style>
    body { background:#000; color:white; font-family:Arial, sans-serif; margin:0; padding:0; }
    .container { max-width:1000px; margin:0 auto; padding:20px; }

    .top-info {
      text-align:center;
      font-size:18px;
      margin-bottom:10px;
      border-bottom:2px solid #ffc800;
      padding-bottom:8px;
    }

    .score-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:20px 0;
    }

    .team-box {
      flex:1;
      text-align:center;
      padding:15px 10px;
      border-radius:10px;
      font-size:22px;
      font-weight:bold;
    }

    .team-home { background:#6ec9ff; color:#000; margin-right:10px; }
    .team-away { background:#001d9b; margin-left:10px; }

    .score-middle {
      font-size:40px;
      min-width:140px;
      text-align:center;
    }

    .possession-chip {
      display:inline-block;
      margin-top:8px;
      font-size:14px;
      padding:4px 10px;
      border-radius:20px;
      border:1px solid #fff;
    }

    .quarter-text { text-align:center; font-size:22px; margin-bottom:20px; }

    .timeline-box {
      border-radius:8px;
      background:#111;
      padding:15px;
    }
    .timeline-box h2 { margin-top:0; }
    .timeline-item {
      border-bottom:1px solid #333;
      padding:6px 4px;
      font-size:14px;
    }
    .timeline-item:last-child { border-bottom:none; }

    /* ENCUESTA: barras tipo ESPN */
    .poll-bars {
      width:100%;
      max-width:500px;
      margin:0 auto;
    }

    .poll-bar {
      margin:8px 0;
    }

    .poll-bar-header {
      display:flex;
      justify-content:space-between;
      font-size:13px;
      margin-bottom:2px;
    }

    .poll-bar-track {
      width:100%;
      height:10px;
      background:#333;
      border-radius:4px;
      overflow:hidden;
    }

    .poll-bar-fill {
      height:100%;
      width:0%;
      transition:width 0.3s ease;
    }

    .poll-bar-home { background:#f7a6a6; }
    .poll-bar-away { background:#94b3ff; }

    #poll_section h2 { margin-bottom:5px; }
  </style>
</head>
<img id="ovt-corner-logo"
     src="https://raw.githubusercontent.com/osvillat-alt/Scoreboard/main/bb6b5054-8bfb-4159-b6c0-b19a23ba52b3.png"
     alt="OVT Logo">

<body>
<div class="container">
  <!-- INFO SUPERIOR -->
  <div class="top-info" id="top_info">Lugar • Fecha</div>

  <!-- MARCADOR -->
  <div class="score-row">
    <div class="team-box team-home">
      <div id="home_name">Local</div>
      <div id="home_possession" class="possession-chip" style="visibility:hidden;">Posesión</div>
    </div>

    <div class="score-middle">
      <span id="score_home">0</span>
      <span> - </span>
      <span id="score_away">0</span>
    </div>

    <div class="team-box team-away">
      <div id="away_name">Visitante</div>
      <div id="away_possession" class="possession-chip" style="visibility:hidden;">Posesión</div>
    </div>
  </div>

  <!-- CUARTO -->
  <div class="quarter-text" id="quarter_text">Cuarto: 1Q</div>

  <!-- ENCUESTA -->
  <div id="poll_section" style="display:none; margin-top:25px;">
    <h2 style="text-align:center;">Encuesta: ¿Quién ganará?</h2>
    <p id="poll_question" style="text-align:center; margin-bottom:10px;"></p>

    <div class="poll-bars">
      <div class="poll-bar">
        <div class="poll-bar-header">
          <span id="poll_home_name">Local</span>
          <span id="poll_home_pct">0%</span>
        </div>
        <div class="poll-bar-track">
          <div id="poll_home_fill" class="poll-bar-fill poll-bar-home"></div>
        </div>
      </div>

      <div class="poll-bar">
        <div class="poll-bar-header">
          <span id="poll_away_name">Visitante</span>
          <span id="poll_away_pct">0%</span>
        </div>
        <div class="poll-bar-track">
          <div id="poll_away_fill" class="poll-bar-fill poll-bar-away"></div>
        </div>
      </div>
    </div>

    <div id="poll_buttons" style="text-align:center; margin-top:12px;">
      <button id="vote_home_btn" style="padding:8px 14px; margin:4px;">Votar Local</button>
      <button id="vote_away_btn" style="padding:8px 14px; margin:4px;">Votar Visitante</button>
    </div>

    <p id="poll_status" style="text-align:center; font-size:13px; opacity:0.85; margin-top:6px;"></p>
  </div>

  <!-- TIMELINE -->
  <div class="timeline-box" style="margin-top:25px;">
    <h2>Crónica del partido</h2>
    <div id="timeline_list"></div>
  </div>
</div>

<script>
  const refGame = db.ref("game");

  // ID de dispositivo (para limitar 1 voto por device)
  const DEVICE_ID = (function () {
    let id = localStorage.getItem("scoreboardDeviceId");
    if (!id) {
      id = "dev-" + Date.now() + "-" + Math.random().toString(16).slice(2);
      localStorage.setItem("scoreboardDeviceId", id);
    }
    return id;
  })();

  function vote(teamSide) {
    refGame.child("pollVotes").child(DEVICE_ID).get().then(snap => {
      if (snap.exists()) {
        document.getElementById("poll_status").innerText = "Ya has votado en esta encuesta.";
        return;
      }

      return refGame.child("pollVotes").child(DEVICE_ID).set({
        team: teamSide,
        at: Date.now()
      });
    }).then(result => {
      if (result !== undefined) {
        document.getElementById("poll_status").innerText = "¡Gracias por votar!";
      }
    }).catch(err => {
      console.error(err);
      document.getElementById("poll_status").innerText = "Ocurrió un error al registrar tu voto.";
    });
  }

  document.getElementById("vote_home_btn").onclick = () => vote("home");
  document.getElementById("vote_away_btn").onclick = () => vote("away");

  refGame.on("value", snap => {
    const data = snap.val() || {};

    // Equipos, marcador, lugar/fecha
    const homeName = data.team_home || "Local";
    const awayName = data.team_away || "Visitante";

    document.getElementById("home_name").innerText  = homeName;
    document.getElementById("away_name").innerText  = awayName;
    document.getElementById("score_home").innerText = data.score_home || 0;
    document.getElementById("score_away").innerText = data.score_away || 0;

    const place = data.location || "";
    const date  = data.date || "";
    document.getElementById("top_info").innerText =
      (place ? place : "") + (place && date ? " • " : "") + (date ? date : "");

    // posesión
    const poss = data.possession || null;
    document.getElementById("home_possession").style.visibility =
      poss === "home" ? "visible" : "hidden";
    document.getElementById("away_possession").style.visibility =
      poss === "away" ? "visible" : "hidden";

    // cuarto
    let qText = data.quarter || "1Q";
    if (qText === "MT") {
      document.getElementById("quarter_text").innerText = "Medio tiempo";
    } else {
      document.getElementById("quarter_text").innerText = "Cuarto: " + qText;
    }

    // timeline
    const tl = data.timeline || [];
    const tlList = document.getElementById("timeline_list");
    tlList.innerHTML = "";
    // mostramos del más antiguo al más reciente
    tl.forEach(item => {
      const div = document.createElement("div");
      div.className = "timeline-item";
      div.textContent = item;
      tlList.appendChild(div);
    });

    // ========== ENCUESTA ==========
    const pollSection  = document.getElementById("poll_section");
    const pollQuestion = document.getElementById("poll_question");
    const homeNameEl   = document.getElementById("poll_home_name");
    const awayNameEl   = document.getElementById("poll_away_name");
    const homePctEl    = document.getElementById("poll_home_pct");
    const awayPctEl    = document.getElementById("poll_away_pct");
    const homeFill     = document.getElementById("poll_home_fill");
    const awayFill     = document.getElementById("poll_away_fill");
    const pollButtons  = document.getElementById("poll_buttons");
    const pollStatus   = document.getElementById("poll_status");

    if (data.pollEnabled) {
      pollSection.style.display = "block";

      pollQuestion.innerText = `¿Quién ganará el encuentro: ${homeName} o ${awayName}?`;
      homeNameEl.innerText   = homeName;
      awayNameEl.innerText   = awayName;

      const votes = data.pollVotes || {};
      let homeCount = 0;
      let awayCount = 0;

      for (const id in votes) {
        const v = votes[id];
        if (v.team === "home") homeCount++;
        else if (v.team === "away") awayCount++;
      }

      const total   = homeCount + awayCount;
      const homePct = total ? Math.round((homeCount / total) * 100) : 0;
      const awayPct = total ? Math.round((awayCount / total) * 100) : 0;

      homePctEl.innerText     = homePct + "%";
      awayPctEl.innerText     = awayPct + "%";
      homeFill.style.width    = homePct + "%";
      awayFill.style.width    = awayPct + "%";

      const yaVoto = votes[DEVICE_ID];
      if (yaVoto) {
        pollButtons.style.display = "none";
        pollStatus.innerText = "Ya has votado en esta encuesta.";
      } else {
        pollButtons.style.display = "block";
        pollStatus.innerText = "";
      }
    } else {
      pollSection.style.display = "none";
    }
  });
</script>

</body>
</html>

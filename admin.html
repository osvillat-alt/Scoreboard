<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administrador del Marcador</title>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
  <script src="firebase.js"></script>

  <style>
    body { background:#111; color:white; font-family:Arial; padding:20px; }
    button, select, input { padding:10px; margin:5px; font-size:18px; }
    .box { border:1px solid #444; padding:15px; margin:10px 0; border-radius:10px; }
  </style>
</head>

<body>

<h1>Panel Administrador (OVT)</h1>

<div class="box">
  <h2>Agregar Nuevo Equipo</h2>
  Nombre <input id="new_team_name"><br>
  Color <input id="new_team_color" type="color" value="#ff0000"><br>
  <button onclick="addTeam()">Guardar Equipo</button>
</div>

<div class="box">
  <h2>Configurar Partido</h2>

  Equipo Local: <select id="team_home_select"></select><br>
  Equipo Visitante: <select id="team_away_select"></select><br>

  Fecha: <input id="date"><br>
  Lugar: <input id="location"><br>

  Cuarto:
  <select id="quarter">
    <option>1Q</option>
    <option>2Q</option>
    <option>3Q</option>
    <option>4Q</option>
    <option>OT</option>
    <option>MT</option> <!-- Medio tiempo -->
  </select>
  <p style="font-size:14px;opacity:0.8;margin-top:5px;">
    MT = Medio tiempo
  </p>
</div>

<div class="box">
  <h2>Posesión</h2>
  <button onclick="setPossession('home')">Local</button>
  <button onclick="setPossession('away')">Visitante</button>
</div>

<div class="box">
  <h2>Anotaciones</h2>
  <button onclick="addPoints('home',6,'Touchdown')">TD Local +6</button>
  <button onclick="addPoints('home',1,'Extra Point')">XP Local +1</button>
  <button onclick="addPoints('home',2,'2pt Conversion')">Conv. 2 pts Local +2</button>
  <button onclick="addPoints('home',3,'Field Goal')">FG Local +3</button>
  <button onclick="addPoints('home',2,'Safety')">Safety Local +2</button><br>

  <button onclick="addPoints('away',6,'Touchdown')">TD Visitante +6</button>
  <button onclick="addPoints('away',1,'Extra Point')">XP Visitante +1</button>
  <button onclick="addPoints('away',2,'2pt Conversion')">Conv. 2 pts Visitante +2</button>
  <button onclick="addPoints('away',3,'Field Goal')">FG Visitante +3</button>
  <button onclick="addPoints('away',2,'Safety')">Safety Visitante +2</button>
</div>

<div class="box">
  <button style="background:red;color:white;" onclick="finishGame()">Finalizar Partido</button>
  <button style="background:#555;color:white;margin-left:10px;" onclick="resetGame()">Reset sin guardar</button>
</div>

<script>
  // Referencias a Firebase (db viene de firebase.js)
  const refTeams = db.ref("teams");
  const refGame  = db.ref("game");

  // ===== FRASES EPICAS =====
  const FRASES_TD = [
    "con una jugada explosiva que rompe la defensa.",
    "tras una serie ofensiva perfecta que culmina en las diagonales.",
    "con un acarreo poderoso que nadie pudo detener.",
    "gracias a un pase preciso que encuentra a su receptor en la zona de anotación.",
    "rematando una larga ofensiva que desgastó por completo a la defensa rival.",
    "aprovechando un error defensivo para convertir seis puntos vitales.",
    "con una jugada sorpresa que tomó desprevenida a la defensiva.",
    "mostrando poder ofensivo y autoridad en la zona roja.",
    "con una gran combinación por aire que termina en touchdown.",
    "tras mover las cadenas con calma y ejecutar a la perfección en zona roja.",
    "encendiendo al público con un touchdown espectacular.",
    "demostrando sangre fría en tercera oportunidad cerca de la zona de anotación.",
    "con una ofensiva rápida que recorrió el campo en pocos intentos.",
    "aprovechando cada yarda para llegar a la zona prometida.",
    "con un ataque terrestre contundente que abre el camino a seis puntos."
  ];

  const FRASES_FG = [
    "con un gol de campo seguro que suma tres puntos al marcador.",
    "aprovechando la oportunidad y eligiendo la vía segura de tres puntos.",
    "con una patada precisa que pasa justo entre los postes.",
    "que les permite acercarse en el marcador con un FG efectivo.",
    "añadiendo tres puntos que podrían ser clave más adelante.",
    "mostrando tranquilidad del pateador en un intento importante.",
    "con un gol de campo que mantiene viva la ofensiva.",
    "acortando la distancia con una patada bien ejecutada.",
    "castigando la defensa rival con tres puntos desde la larga distancia.",
    "tras quedarse cortos en zona roja pero capitalizando con un FG.",
    "asegurando puntos en una serie que parecía perderse.",
    "con una patada que mantiene la presión sobre el rival.",
    "sumando de a poco pero sin dejar de anotar.",
    "que mantiene el juego dentro de una posesión.",
    "con un gol de campo que silencía momentáneamente a la afición rival."
  ];

  const FRASES_XP = [
    "convirtiendo sin problemas el punto extra.",
    "asegurando el punto adicional para completar la serie.",
    "sumando un punto más que redondea la anotación.",
    "manteniendo la confianza en la unidad de gol de campo.",
    "con una patada sencilla pero importante para el marcador.",
    "completando los siete puntos tras el touchdown.",
    "demostrando solidez en la ejecución del punto extra.",
    "sin margen de error en el intento de XP.",
    "sumando un punto que podría marcar diferencia al final.",
    "cerrando la ofensiva con el adicional bueno.",
    "mostrando seguridad total del pateador.",
    "con un XP perfecto que no deja dudas.",
    "añadiendo un punto más a la cuenta.",
    "confirmando la ventaja obtenida con el touchdown.",
    "redondeando una gran serie ofensiva."
  ];

  const FRASES_SAFETY = [
    "gracias a una defensa implacable que encierra al rival en su propia zona.",
    "aprovechando la presión defensiva para forzar el error en la zona de anotación.",
    "con una jugada defensiva enorme que termina en safety.",
    "demostrando un front defensivo dominante que no da respiro.",
    "forzando al mariscal rival a cometer un error costoso en su propia zona.",
    "haciendo sentir el peso de la defensiva y sumando dos puntos importantes.",
    "castigando a la ofensiva rival con una jugada espectacular detrás de la línea.",
    "con un safety que cambia la inercia del partido.",
    "demostrando que la defensa también puede poner puntos en el marcador.",
    "aprovechando una mala protección para encerrar al corredor.",
    "haciendo retroceder tanto a la ofensiva rival que terminan dentro de su propia zona.",
    "con una lectura perfecta de la jugada ofensiva para conseguir el safety.",
    "sumando dos puntos defensivos que levantan al equipo.",
    "dejando claro que no hay espacio para errores cerca de la propia zona.",
    "con una jugada defensiva que prende fuego a la banca y a la afición."
  ];

  const FRASES_2PT = [
    "arriesgando con una conversión de dos puntos que sale perfecta.",
    "demostrando agresividad ofensiva al ir por dos y conseguirlo.",
    "aprovechando el momento para sumar dos puntos extra fundamentales.",
    "rompiendo el guion con una jugada de dos puntos muy bien ejecutada.",
    "mandando un mensaje claro: este equipo viene a ganar, no a conformarse con uno.",
    "con una conversión de dos puntos que mantiene la presión sobre la defensa rival.",
    "decidiendo no ir por el punto extra tradicional y cobrando dos completos.",
    "con una jugada diseñada específicamente para la conversión, ejecutada a la perfección.",
    "mostrando confianza total en la ofensiva al buscar y conseguir dos puntos más.",
    "sumando dos puntos que pueden marcar la diferencia en un cierre apretado.",
    "con una conversión que hace explotar a la banca y a la afición.",
    "aprovechando la confusión defensiva para convertir dos puntos más.",
    "arriesgando en la zona roja y siendo recompensados con dos puntos adicionales.",
    "con una jugada engaño que termina en conversión de dos puntos.",
    "sumando dos puntos que amplían la ventaja en el momento justo."
  ];

  function extraContexto({ esOT, esRemontada, esCerrado, esPaliza }) {
    if (esOT)       return " En un tiempo extra lleno de tensión, cada jugada cuenta al máximo.";
    if (esRemontada)return " Esta jugada completa una gran remontada que cambia la historia del partido.";
    if (esCerrado)  return " El marcador sigue muy cerrado y cada punto pesa muchísimo.";
    if (esPaliza)   return " La ventaja sigue creciendo y el dominio es cada vez más claro.";
    return "";
  }

  function narrarJugada(data, teamSide, pts, tipoCorto) {
    const quarter      = data.quarter || "";
    const nombreEquipo = teamSide === "home" ? data.team_home : data.team_away;

    const oldHome = data.score_home || 0;
    const oldAway = data.score_away || 0;

    const newHome = teamSide === "home" ? oldHome + pts : oldHome;
    const newAway = teamSide === "away" ? oldAway + pts : oldAway;

    const accionBase = `${quarter} • ${tipoCorto} de ${nombreEquipo} (${pts} pts)`;

    const diffNueva = Math.abs(newHome - newAway);

    const ibaPerdiendo =
      (teamSide === "home" && oldHome < oldAway) ||
      (teamSide === "away" && oldAway < oldHome);

    const ahoraVaGanando =
      (teamSide === "home" && newHome > newAway) ||
      (teamSide === "away" && newAway > newHome);

    const esRemontada = ibaPerdiendo && ahoraVaGanando;
    const esCerrado   = diffNueva <= 3;
    const esPaliza    = diffNueva >= 20;
    const esOT        = quarter === "OT";

    let pool = [];
    if (tipoCorto === "TD")          pool = FRASES_TD;
    else if (tipoCorto === "FG")     pool = FRASES_FG;
    else if (tipoCorto === "XP")     pool = FRASES_XP;
    else if (tipoCorto === "2PT")    pool = FRASES_2PT;
    else if (tipoCorto === "Safety") pool = FRASES_SAFETY;

    const frase = pool[Math.floor(Math.random() * pool.length)] || "";
    const extra = extraContexto({ esOT, esRemontada, esCerrado, esPaliza });

    return `${accionBase} ${frase}${extra}`.trim();
  }

  // ===== LÓGICA DEL PANEL =====

  function addTeam() {
    const name  = document.getElementById("new_team_name").value.trim();
    const color = document.getElementById("new_team_color").value;

    if (!name) {
      alert("Escribe un nombre primero");
      return;
    }

    refTeams.child(name).set({ color })
      .then(() => {
        alert("Equipo guardado");
        document.getElementById("new_team_name").value = "";
      })
      .catch(err => {
        console.error(err);
        alert("Error al guardar el equipo");
      });
  }

  refTeams.on("value", snap => {
    const teams = snap.val() || {};
    const homeSel = document.getElementById("team_home_select");
    const awaySel = document.getElementById("team_away_select");
    homeSel.innerHTML = "";
    awaySel.innerHTML = "";
    for (const t in teams) {
      homeSel.innerHTML += `<option>${t}</option>`;
      awaySel.innerHTML += `<option>${t}</option>`;
    }
  });

  let lastQuarter = null;

  setInterval(() => {
    const qSel   = document.getElementById("quarter").value || "1Q";
    const home   = document.getElementById("team_home_select").value || "";
    const away   = document.getElementById("team_away_select").value || "";
    const date   = document.getElementById("date").value || "";
    const place  = document.getElementById("location").value || "";

    // detectar cambio de cuarto y escribir al timeline
    if (lastQuarter === null) {
      lastQuarter = qSel;
    } else if (qSel !== lastQuarter) {
      refGame.once("value").then(snap => {
        const data = snap.val() || {};
        const tl = data.timeline || [];

        let msg = "";
        if (qSel === "MT") {
          msg = `Termina el ${lastQuarter}. Entramos a medio tiempo.`;
        } else if (lastQuarter === "MT") {
          msg = `Termina el medio tiempo, comienza el ${qSel}.`;
        } else {
          msg = `Se termina el ${lastQuarter}. Comienza el ${qSel}.`;
        }

        const nuevoTL = [...tl, msg];

        refGame.update({
          team_home: home,
          team_away: away,
          date:      date,
          location:  place,
          quarter:   qSel,
          timeline:  nuevoTL
        });

        lastQuarter = qSel;
      });
      return; // ya actualizamos, no seguimos abajo
    }

    // actualización normal
    refGame.update({
      team_home: home,
      team_away: away,
      date:      date,
      location:  place,
      quarter:   qSel
    });
  }, 1500);

  function setPossession(team) {
    refGame.update({ possession: team });
  }

  function addPoints(teamSide, pts, tipoLabel) {
    refGame.once("value").then(snap => {
      const data = snap.val() || {};

      const oldHome = data.score_home || 0;
      const oldAway = data.score_away || 0;

      let tipoCorto = "";
      if (tipoLabel.includes("Touchdown"))           tipoCorto = "TD";
      else if (tipoLabel.includes("Field Goal"))     tipoCorto = "FG";
      else if (tipoLabel.includes("2pt") ||
               tipoLabel.includes("2pt Conversion")) tipoCorto = "2PT";
      else if (tipoLabel.includes("Extra") ||
               tipoLabel.includes("XP"))             tipoCorto = "XP";
      else if (tipoLabel.includes("Safety"))         tipoCorto = "Safety";

      const fraseCompleta = narrarJugada(
        { ...data, score_home: oldHome, score_away: oldAway },
        teamSide,
        pts,
        tipoCorto
      );

      const timelineActual = data.timeline || [];
      const nuevoTimeline  = [...timelineActual, fraseCompleta];

      const newHome = teamSide === "home" ? oldHome + pts : oldHome;
      const newAway = teamSide === "away" ? oldAway + pts : oldAway;

      refGame.update({
        score_home: newHome,
        score_away: newAway,
        timeline:   nuevoTimeline
      });
    });
  }

  function finishGame() {
    refGame.once("value").then(snap => {
      const data = snap.val() || {};

      const homeName = data.team_home || "Local";
      const awayName = data.team_away || "Visitante";
      const home     = data.score_home || 0;
      const away     = data.score_away || 0;

      const tl = data.timeline || [];
      const finalMsg = `FINAL • El partido termina con marcador ${homeName} ${home} - ${away} ${awayName}.`;

      const timestamp = Date.now();
      const historyRef = db.ref("history").child(timestamp.toString());

      const historyData = {
        ...data,
        finished: true,
        timeline: [...tl, finalMsg],
        finishedAt: timestamp
      };

      // 1) Guardar el partido en historial
      historyRef.set(historyData)
        .then(() => {
          // 2) Resetear el nodo "game" para un nuevo partido
          return refGame.set({
            team_home: "",
            team_away: "",
            date: "",
            location: "",
            quarter: "1Q",
            score_home: 0,
            score_away: 0,
            possession: null,
            timeline: []
          });
        })
        .then(() => {
          // 3) Limpiar campos del panel admin
          document.getElementById("team_home_select").value = "";
          document.getElementById("team_away_select").value = "";
          document.getElementById("date").value = "";
          document.getElementById("location").value = "";
          document.getElementById("quarter").value = "1Q";

          alert("Partido finalizado, guardado en historial y marcador reiniciado.");
        })
        .catch(err => {
          console.error(err);
          alert("Ocurrió un error al finalizar el partido.");
        });
    });
  }

  function resetGame() {
    if (!confirm("¿Seguro que quieres resetear el marcador sin guardar este partido en el historial?")) return;

    refGame.set({
      team_home: "",
      team_away: "",
      date: "",
      location: "",
      quarter: "1Q",
      score_home: 0,
      score_away: 0,
      possession: null,
      timeline: []
    }).then(() => {
      document.getElementById("team_home_select").value = "";
      document.getElementById("team_away_select").value = "";
      document.getElementById("date").value = "";
      document.getElementById("location").value = "";
      document.getElementById("quarter").value = "1Q";
      alert("Marcador reseteado.");
    }).catch(err => {
      console.error(err);
      alert("No se pudo resetear el marcador.");
    });
  }
</script>

</body>
</html>
